

<!doctype html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>Tree mode</title>
	
	
	<script src='../../../codebase/dhtmlxscheduler.js' type="text/javascript" charset="utf-8"></script>
	<script src='../../../codebase/ext/dhtmlxscheduler_timeline.js' type="text/javascript" charset="utf-8"></script>
	<script src='../../../codebase/ext/dhtmlxscheduler_treetimeline.js' type="text/javascript" charset="utf-8"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

	<link rel='stylesheet' type='text/css' href='../../../codebase/dhtmlxscheduler.css'>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	
</head>

	
<style type="text/css" >
	html, body{
		margin:0px;
		padding:0px;
		height:100%;
		overflow:hidden;
	}	
	.one_line{
		white-space:nowrap;
		overflow:hidden;
		padding-top:5px; padding-left:5px;
		text-align:left !important;
	}
	.dhx_cal_event_line{
		height: 54px !important;
		border-radius: 0;
	    background-color: #bbb;
	    border: #888 solid 1px;
	}
	.dhx_event_resize{
		height: 54px !important;
	}
	#shift_form {
		position: absolute;
		top: 100px;
		left: 200px;
		z-index: 10001;
		display: none;
		background-color: white;
		border: 2px solid teal;
		padding: 20px;
		font-family: Tahoma;
		font-size: 10pt;
		border-radius: 10px;
	}
	#shift_form label {
		color: gray;
	}
</style>

<script type="text/javascript" charset="utf-8">
	function getMonday(d) {
	  d = new Date(d);
	  var day = d.getDay(),
	      diff = d.getDate() - day + (day == 0 ? -6:1); // adjust when day is sunday
	  return new Date(d.setDate(diff));
	}

	function init(units, slots) {

		scheduler.locale.labels.timeline_tab = "Timeline";
		scheduler.locale.labels.section_custom="Section";
		scheduler.config.details_on_create=true;
		scheduler.config.details_on_dblclick=true;
		scheduler.config.xml_date="%Y-%m-%d %H:%i";
		
		
		//===============
		//Configuration
		//===============	

		scheduler.createTimelineView({
			section_autoheight: false,
			name:	"timeline",
			x_unit:	"day",
			x_date:	"%j %D",
			x_step:	1,
			x_size: 7,
			y_unit: units,
			y_property:	"section_id",
			round_position: true,
			render: "tree",
			folder_dy:20,
			dy:60
		});
		
		//===============
		//Data loading
		//===============
		scheduler.init('scheduler_here',getMonday(new Date()),"timeline");
		
		scheduler.parse(slots,"json");
	}

	var format = scheduler.date.date_to_str("%H:%i");
	scheduler.templates.event_bar_text = function(sd, ed, ev){
		// console.log(ev);
		return format(sd)+" - "+format(ed) + "<br>" + ev.text + "<br>(" + ev.break + " min break)";
	}
			
	scheduler.showLightbox = function(id) {
		var ev = scheduler.getEvent(id);
		scheduler.startLightbox(id, document.getElementById("shift_form"));

		$("#description").val( ev.text );
		$("#break").val( ev.break || "" );
		console.log(ev.start_date);
		console.log(ev.end_date);
		$("#sel_start_time").val( ev.start_date.getHours() );
		$("#sel_end_time").val( ev.end_date.getHours() );
	};

	function save_form() {
		var ev = scheduler.getEvent(scheduler.getState().lightbox_id);
		ev.text = $("#description").val();
		ev.break = $("#break").val();

		ev.end_date.setDate(ev.start_date.getDate());
		ev.start_date.setHours($("#sel_start_time").val());
		ev.end_date.setHours($("#sel_end_time").val());
		console.log(ev.start_date);
		console.log(ev.end_date);

		scheduler.endLightbox(true, document.getElementById("shift_form"));
	}
	function close_form() {
		scheduler.endLightbox(false, document.getElementById("shift_form"));
	}

	function delete_event() {
		var event_id = scheduler.getState().lightbox_id;
		scheduler.endLightbox(false, document.getElementById("shift_form"));
		scheduler.deleteEvent(event_id);
	}

	$(document).ready(function(){
		for (var i = 0; i < 24; i++) {
			var text = i % 12 + (i < 12 ? " am" : " pm");
			if (i == 12) text = "12 pm"
			$("#sel_start_time").append(new Option( text, i));
			$("#sel_end_time").append(new Option( text, i));
		}

		var EmployeeLimit = 100000;
	    var allData;
		var locations=null, roles=null, employees=null, shifts=null;
		$.ajax({
		  	url: "rota_data.json",
		  	type: 'GET'
		})
		.done(function(data) {
			allData = JSON.parse(data);
			locations = allData.locations;
			roles = allData.roles;
			employees = allData.employees;
			shifts = allData.shifts;
			var units = getUnits(roles, employees);
			console.log(units);
			var shiftSlots = getShiftSlots(roles, employees, shifts);
			console.log(shiftSlots);
			init(units, shiftSlots);
		})
		.fail(function(error) {
			console.log(error);
		});

		$('button').click(function(){
			// var evs = scheduler.getEvents(new Date(2017,4,24),new Date(2017,4,30)); 
			// console.log(evs);
		});

		function getUnits(roles, employees) {
			var unitOpenShift = {key: EmployeeLimit, label: "Open Shifts"};
			var units = [unitOpenShift];
			for (var i = 0; i < roles.length; i++) {
				var unit = {key: i+1, label: roles[i]['name'], open: true, children: []};
				units.push(unit);
			}

			for (var i = 0; i < employees.length; i++) {
				var defaultRole = employees[i]['defaultrole'];
				var unit = {key: generateSectionID(defaultRole, i), label: employees[i]['name']};
				units[defaultRole + 1]['children'].push(unit);
			}
			return units;
		}

		function getShiftSlots(roles, employees, shifts) {
			var shiftSlots = [];
			for (var i = 0; i < shifts.length; i++) {
				var sectionId = EmployeeLimit;
				var color = "lightgray";
				if (shifts[i]['employee'] >= 0) {
					sectionId = generateSectionID( employees[shifts[i]['employee']]['defaultrole'], shifts[i]['employee'] );
					color = roles[employees[shifts[i]['employee']]['defaultrole']]['color'];
				}
				var shiftSlot = {start_date: shifts[i]['start_date'], end_date: shifts[i]['end_date'], text: shifts[i]['task'], section_id: sectionId, color: color, break: shifts[i]['break']}
				shiftSlots.push(shiftSlot);
			}
			return shiftSlots;
		}

		function generateSectionID(roleId, employeeId) {
			return (roleId + 1) * EmployeeLimit + employeeId + 1;
		}
	});
</script>

<div id="shift_form">
	<form class="form-horizontal">
		<div class="lead text-info">Add Shift</div>
		<div class="form-group">
			<label class="col-md-1" for="select_time"><i class="glyphicon glyphicon-time"></i></label>
	    	<div class="col-md-6">
	    		<select id="sel_start_time"></select> -
	    		<select id="sel_end_time"></select>
	      	</div>
	      	<label class="col-md-2" for="break">Break</label>
	    	<div class="col-md-3">
	    		<input type="text" id="break" style="width: 30px"></input>
	    		<span>mins</span>
	      	</div>
		</div>
		<div class="form-group">
	      <label class="control-label col-md-1" for="description"><i class="glyphicon glyphicon-comment"></i></label>
	      <div class="col-md-11">
	        <textarea class="form-control" id="description" placeholder="Notes..."></textarea>
	        <p>Employees can only see notes for their own shifts</p>
	      </div>
	    </div>
	    <div class="form-group">
	    	<div class="col-md-offset-1">
	    		<input type="checkbox" name="publish" id="publish">
	    		Publish and send notification?
	    	</div>
	    </div>
	    <div class="form-group" style="margin-top:50px">        
	      	<div class=" col-md-6">
			    <input type="button" class="btn btn-primary btn-sm" name="save" value="Add" id="save"  onclick="save_form()"> or
				<input type="button" class="btn btn-secondary btn-sm" name="close" value="Cancel" id="close" onclick="close_form()">
	      	</div>
	      	<div class="col-md-6 text-right">
	      		<input type="button" class="btn btn-danger btn-sm" name="delete" value="Delete" id="delete"  onclick="delete_event()">
	      	</div>
	    </div>

		<!-- <input type="text" name="start_date" value="" id="start_date"> -->
		<!-- <input type="text" name="end_date" value="" id="end_date"> -->
	</form>
</div>

<body>
	<div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:100%;'>
		<div class="dhx_cal_navline">
			<div class="dhx_cal_prev_button">&nbsp;</div>
			<div class="dhx_cal_next_button">&nbsp;</div>
			<div class="dhx_cal_today_button"></div>
			<div class="dhx_cal_date"></div>
			<div class="dhx_cal_tab" name="day_tab" style="right:204px;"></div>
			<div class="dhx_cal_tab" name="week_tab" style="right:140px;"></div>
			<div class="dhx_cal_tab" name="timeline_tab" style="right:280px;"></div>
			<div class="dhx_cal_tab" name="month_tab" style="right:76px;"></div>
		</div>
		<div class="dhx_cal_header">
		</div>
		<div class="dhx_cal_data">
		</div>		
	</div>
</body>